name: GitHub Metrics

on:
  # Weekly updates (Monday at 00:00 UTC)
  schedule:
    - cron: "0 0 * * 1"

  # Manual dispatch
  workflow_dispatch:

  # Optional: updates when pushing to main/master
  push:
    branches:
      - main
      - master

# GitHub recommended best practice: set permissions at top-level
permissions:
  contents: write

# Prevent overlapping runs
concurrency:
  group: github-metrics-${{ github.ref }}
  cancel-in-progress: true

env:
  METRICS_TOKEN: ${{ secrets.METRICS_TOKEN }}
  METRICS_USER: slsevilla

jobs:
  github-metrics:
    runs-on: ubuntu-latest

    steps:
      # ---------------------------------------------------------
      #  BASE PROFILE METRICS
      # ---------------------------------------------------------
      - name: Base Metrics
        uses: lowlighter/metrics@v3.34
        with:
          token: ${{ env.METRICS_TOKEN }}
          user: ${{ env.METRICS_USER }}
          filename: github-metrics.svg

          base: header, activity, community, metadata
          base_indepth: true
          repositories: 200

          template: classic
          config_timezone: America/New_York
          optimize: svg

      # ---------------------------------------------------------
      #  LANGUAGES (FAST, BIOINFORMATICS-OPTIMIZED)
      # ---------------------------------------------------------
      - name: Languages
        uses: lowlighter/metrics@v3.34
        with:
          token: ${{ env.METRICS_TOKEN }}
          user: ${{ env.METRICS_USER }}
          filename: metrics.plugin.languages.svg

          base: ""

          plugin_languages: true
          # Only use "most-used" to avoid the buggy recent analyzer
          plugin_languages_sections: most-used

          # ðŸš« Turn OFF indepth mode so it doesn't crawl every repo
          plugin_languages_indepth: false

          # Still keep a reasonable analysis timeout in case it kicks in
          plugin_languages_analysis_timeout: 60
          plugin_languages_details: bytes-size, percentage

          # Bioinformatics-focused: hide mostly presentation tech
          plugin_languages_ignored: html, css, scss, PostScript, Apex, Eiffel

          # Optional tuning (uncomment if desired)
          # plugin_languages_limit: 10
          # plugin_languages_threshold: 2
          # plugin_languages_other: false

      # ---------------------------------------------------------
      #  NOTABLE CONTRIBUTIONS
      # ---------------------------------------------------------
      - name: Notable Contributions
        uses: lowlighter/metrics@v3.34
        with:
          token: ${{ env.METRICS_TOKEN }}
          user: ${{ env.METRICS_USER }}
          filename: metrics.plugin.notable.svg

          base: ""

          plugin_notable: true
          plugin_notable_indepth: true
          plugin_notable_repositories: true
          plugin_notable_self: true
          plugin_notable_types: commit, pull_request, issue

          # Optional filters:
          # plugin_notable_from: organization
          # plugin_notable_repositories_ignored: slsevilla/test
